<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="kaizeiの日常"><title>Objective-C Resolve Method | kaizeiとyimi</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/blog/css/highlight.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="shortcut icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/blog/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Objective-C Resolve Method</h1><a id="logo" href="/blog/.">kaizeiとyimi</a><p class="description">kaizeiの日常</p></div><div id="nav-menu"><a href="/blog/." class="current"><i class="fa fa-home"> </i><span>首页</span></a><a href="/blog/archives/"><i class="fa fa-archive"> </i><span>归档</span></a><a href="/blog/about/"><i class="fa fa-user"> </i><span>关于</span></a><a href="/blog/atom.xml"><i class="fa fa-rss"> </i><span>订阅</span></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Objective-C Resolve Method</h1><div class="post-meta">Jun 10, 2014<span> | </span><span class="category"><a href="/blog/categories/技术/">技术</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>本文简单介绍了一下<code>objective-c</code>中为类在运行时动态添加方法的技术.</p>
<blockquote>
<p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048" target="_blank" rel="external">apple runtime 文档</a> 文档中介绍了runtime知识以及resolve method的一些内容，但是不详细。。。。</p>
</blockquote>
<p>动态消息决议是在一个对象不能处理某个selector时所发生的。决议比消息转发要先发生，如果决议成功，则会调用方法，不会继续转发流程，否则进入转发流程。</p>
<p>决议有两个方式，一个是添加实例方法，一个是添加类方法。现在互联网上的帖子大多数都是抄袭，基本上都只讲到如何添加实例方法而对于类方法的添加都是一笔带过。本文将真正介绍如何添加实例方法和类方法。</p>
<p>NSObject的类声明中有如下代码:</p>
<pre><code class="objc hljs">+ (<span class="hljs-built_in">BOOL</span>)resolveClassMethod:(SEL)sel __OSX_<span class="hljs-built_in">AVAILABLE_STARTING</span>(__MAC_10_5, __IPHONE_2_0);
+ (<span class="hljs-built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel __OSX_<span class="hljs-built_in">AVAILABLE_STARTING</span>(__MAC_10_5, __IPHONE_2_0);</code></pre><p>前者是决议类方法，后者决议实例方法。触发决议的流程很简单，只需要对某个<strong>对象</strong>发送其不能响应的消息即可。然后会根据对象的性质调用不同的决议方法。如果是实例对象则调用<code>resolveInstanceMethod</code>，如果是class对象则调用<code>resloveClassMethod</code>。
要了解如何给<strong>对象</strong>动态添加方法需要知道objective-c中的类继承结构，以及理解class对象。</p>
<h3 id="objective-c的类结构"><a href="#objective-c的类结构" class="headerlink" title="objective-c的类结构"></a>objective-c的类结构</h3><p>某个类如<code>XLPerson</code>，它继承自<code>NSObject</code>，一个实例为<code>personA</code>。<code>personA</code>的类为<code>XLPerson</code>，<code>XLPerson</code>是一个class对象，它的类是一种metaClass，用以下代码可以获取：</p>
<pre><code class="objc hljs">OBJC_EXPORT Class objc_getMetaClass(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name)
    __OSX_<span class="hljs-built_in">AVAILABLE_STARTING</span>(__MAC_10_0, __IPHONE_2_0);</code></pre><p>在本例中调用为<code>objc_getMetaClass(“XLPerson”)</code>,获取到的class对象是<code>XLPerson</code>的metaClass，亦即<code>XLPerson</code>的类。</p>
<h3 id="消息决议的示例代码"><a href="#消息决议的示例代码" class="headerlink" title="消息决议的示例代码"></a>消息决议的示例代码</h3><ol>
<li>决议实例方法  </li>
</ol>
<pre><code class="objc hljs">+ (<span class="hljs-built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel
{
    <span class="hljs-keyword">if</span> (sel == <span class="hljs-keyword">@selector</span>(printWithInstance)) {
        IMP imp = imp_implementationWithBlock(^(<span class="hljs-keyword">id</span> _<span class="hljs-keyword">self</span>, SEL sel) {
            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"print with instance"</span>);
        });
        class_addMethod(<span class="hljs-keyword">self</span>, sel, imp, <span class="hljs-string">"v@:"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
    }
    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">super</span> resolveClassMethod:sel];
}</code></pre><p>简单解释下，发现是<code>printWithInstance</code>的selector，手动做了一个<code>IMP</code>，然后给class对象加上。然后返回YES，告诉iOS已经决议成功，然后iOS会再尝试去class对象的<code>dispatch table</code>中寻找该实例方法，然后找到了，调用，打印出<code>print with instance</code>。</p>
<ol>
<li>决议类方法</li>
</ol>
<pre><code class="objc hljs">+ (<span class="hljs-built_in">BOOL</span>)resolveClassMethod:(SEL)sel
{
    <span class="hljs-keyword">if</span> (sel == <span class="hljs-keyword">@selector</span>(printWithClass)) {
        IMP imp = imp_implementationWithBlock(^(Class class, SEL sel) {
            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"print with class"</span>);
        });
        class_addMethod(objc_getMetaClass(<span class="hljs-built_in">NSStringFromClass</span>(<span class="hljs-keyword">self</span>).UTF8String), sel, imp, <span class="hljs-string">"v@:"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
    }
    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">super</span> resolveClassMethod:sel];
}</code></pre><p>决议类方法和决议实例方法的流程是一样的。唯一不同的是需要在<code>dispatch table</code>中添加方法的类对象不一样，对于类方法决议，需要在class对象的metaClass中添加。因为对class对象发送消息时需要到其metaClass的<code>dispatch table</code>中寻找，这跟调用实例方法时需要到class对象寻找是一样的。</p>
<h3 id="type-encoding"><a href="#type-encoding" class="headerlink" title="type encoding"></a>type encoding</h3><p>上述两例中都在 <code>class_addMethod</code> 调用中传递了<code>“v@:”</code>作为最后一个参数来描述添加的方法的类型。这里注意不要用oc的中括号调用所干扰，方法的type encoding是其对应的c语言调用的类型，因为方法调用会转换为<code>returnType msgSend(id receiver, SEL cmd, ...)</code>，上例中的<code>v@:</code>代表添加的方法返回值为void(v), receiver是对象(@),cmd是selector(:)，没有其他参数。更多关于type encoding的介绍在苹果runtime文档中最后部分有介绍。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>学习只有脚踏实地才能学到。oc的runtime是整个语言的精髓，不理解它将不能理解很多oc才有的精良设计。</p>
</div><div class="article-share"><script type="text/javascript" src="/blog/js/share.js?v=0.0.0" async></script><a data-url="" data-id="ciooc9urj0002aapgwbbu8y7e" class="article-share-link">分享</a><div class="article-share-box"><div class="article-share-links"><a target="_blank" title="Twitter" class="article-share-twitter"></a><a target="_blank" title="Facebook" class="article-share-facebook"></a><a target="_blank" title="Sina Weibo" class="article-share-sinaweibo"></a><a target="_blank" title="Wechat" class="article-share-wechat"></a></div></div></div><div class="tags"><a href="/blog/tags/iOS/">iOS</a></div><div class="post-nav"><a href="/blog/2014/06/10/objective-c_coding_guidelines_translation/" class="pre">Coding Guidelines for Cocoa 翻译</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar-placeholder"> </div><div id="sidebar-container"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Google"/><input type="hidden" name="sitesearch"/><script>var input=document.getElementsByName('sitesearch')[0];if(input){input.setAttribute('value', window.location.host);}</script></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/日常/">日常</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/blog/tags/XCode/" style="font-size: 15px;">XCode</a> <a href="/blog/tags/Github/" style="font-size: 15px;">Github</a> <a href="/blog/tags/年终总结/" style="font-size: 15px;">年终总结</a> <a href="/blog/tags/swift/" style="font-size: 15px;">swift</a> <a href="/blog/tags/NativeScript/" style="font-size: 15px;">NativeScript</a> <a href="/blog/tags/JS/" style="font-size: 15px;">JS</a> <a href="/blog/tags/cocoapods/" style="font-size: 15px;">cocoapods</a> <a href="/blog/tags/workspace/" style="font-size: 15px;">workspace</a> <a href="/blog/tags/心情/" style="font-size: 15px;">心情</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/26/break-swift-init-rule/">对swift中单例的init搞破坏</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/20/the-Twenty-of-May/">the Twenty of May</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/19/reuse-internal-codes/">复用内部公用代码的几种方式</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/04/17/make-AutoLayout-X/">make AutoLayout X</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/04/13/改用hexo了/">改用hexo了!</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/04/13/swift-AnyObject-little-tips/">swift AnyObject little tips</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/04/11/nativescript/">集成NativeScript iOSRuntime到已有工程</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/03/28/swift_type_convert/">swift 2.2 类型转换小坑</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/03/15/年后小总结/">2016 年后小总结</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/12/08/XLYAutoLayoutEasy/">XLYAutoLayoutEasy</a></li></ul></div></div><script type="text/javascript" src="/blog/js/sidebar.js?v=0.0.0"></script></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/blog/." rel="nofollow">kaizei.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a> Modified by <a rel="nofollow" target="_blank" href="https://github.com/kaizeiyimi">ME.</a></div></div></div></div></body></html>